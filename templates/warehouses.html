{% extends 'layout.html' %}

{% block body %}
<div class="container mt-5 vh-100">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            Warehouse Prediction
            <span class="badge bg-light text-primary" id="warehouseCount">0 Warehouses</span>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="inventoryFile" class="form-label">Upload Inventory CSV</label>
                    <input class="form-control" type="file" id="inventoryFile" name="inventory_file" accept=".csv" required>
                </div>
                <button type="submit" class="btn btn-primary">Predict Warehouses</button>
            </form>

            {% if warehouses %}
            <div class="mt-4">
                <h5>Predicted Warehouses:</h5>
                <div class="row" id="warehouseList">
                    {% for warehouse in warehouses %}
                    <div class="col-md-4 mb-3">
                        <div class="card {% if warehouse.size_category == 'Large' %}border-success{% elif warehouse.size_category == 'Medium' %}border-warning{% else %}border-info{% endif %}">
                            <div class="card-body">
                                <h5 class="card-title">{{ warehouse.district }}</h5>
                                <p class="card-text">
                                    <strong>Size Category:</strong> 
                                    <span class="badge {% if warehouse.size_category == 'Large' %}bg-success{% elif warehouse.size_category == 'Medium' %}bg-warning{% else %}bg-info{% endif %}">
                                        {{ warehouse.size_category }}
                                    </span>
                                </p>
                                <p class="card-text">
                                    <strong>Warehouse Size:</strong> {{ warehouse.size_sqm }} sq meters
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <h5 class="mt-4">Warehouse Map:</h5>
                <div id="map" style="height: 500px; width: 100%;"></div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key={{ map_key }}"></script>
<script>
    function initMap() {
        const center = { lat: 28.3949, lng: 84.1240 }; // Center of Nepal
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 7,
            center: center,
        });

        const warehouses = {{ warehouses|tojson }};
        
        // Update warehouse count
        document.getElementById('warehouseCount').textContent = `${warehouses.length} Warehouses`;

        warehouses.forEach((warehouse) => {
            // Custom marker colors based on warehouse size
            let markerColor = 'http://maps.google.com/mapfiles/ms/icons/';
            if (warehouse.size_category === 'Large') {
                markerColor += 'green-dot.png';
            } else if (warehouse.size_category === 'Medium') {
                markerColor += 'yellow-dot.png';
            } else {
                markerColor += 'blue-dot.png';
            }

            const marker = new google.maps.Marker({
                position: { lat: warehouse.latitude, lng: warehouse.longitude },
                map: map,
                title: `${warehouse.district} (${warehouse.size_category})`,
                icon: markerColor
            });

            // Add info window
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div>
                        <h6>${warehouse.district}</h6>
                        <p>Size: ${warehouse.size_category} (${warehouse.size_sqm} sq meters)</p>
                    </div>
                `
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });
        });
    }

    {% if warehouses %}
    initMap();
    {% endif %}
</script>
{% endblock %}